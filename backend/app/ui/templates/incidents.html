{% extends "base.html" %}

{% block title %}Incidents - IncidentAI{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-8">
    <div>
        <h1 class="text-3xl font-bold bg-gradient-to-r from-white to-gray-400 bg-clip-text text-transparent">
            Incidents
        </h1>
        <p class="text-base-content/60 mt-1">All detected incidents and their AI-generated analysis</p>
    </div>
    <div class="flex gap-3">
        <select id="status-filter" class="select select-bordered select-sm" onchange="applyFilters()">
            <option value="">All Statuses</option>
            <option value="OPEN">Open</option>
            <option value="INVESTIGATING">Investigating</option>
            <option value="RESOLVED">Resolved</option>
        </select>
        <select id="severity-filter" class="select select-bordered select-sm" onchange="applyFilters()">
            <option value="">All Severities</option>
            <option value="SEV1">SEV1</option>
            <option value="SEV2">SEV2</option>
            <option value="SEV3">SEV3</option>
            <option value="SEV4">SEV4</option>
        </select>
        <button onclick="fetchIncidents()" class="btn btn-outline btn-sm gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Refresh
        </button>
    </div>
</div>

<!-- Stats Summary -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="stat-card-gradient rounded-2xl p-5">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-base-content/60 text-sm">Total</p>
                <p class="text-3xl font-bold font-mono mt-1" id="total-count">-</p>
            </div>
            <div class="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center">
                <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
            </div>
        </div>
    </div>
    <div class="stat-card-gradient rounded-2xl p-5">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-base-content/60 text-sm">Open</p>
                <p class="text-3xl font-bold font-mono mt-1 text-error" id="open-count">-</p>
            </div>
            <div class="w-12 h-12 rounded-xl bg-error/20 flex items-center justify-center">
                <svg class="w-6 h-6 text-error" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
        </div>
    </div>
    <div class="stat-card-gradient rounded-2xl p-5">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-base-content/60 text-sm">Investigating</p>
                <p class="text-3xl font-bold font-mono mt-1 text-warning" id="investigating-count">-</p>
            </div>
            <div class="w-12 h-12 rounded-xl bg-warning/20 flex items-center justify-center">
                <svg class="w-6 h-6 text-warning animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
        </div>
    </div>
    <div class="stat-card-gradient rounded-2xl p-5">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-base-content/60 text-sm">Resolved</p>
                <p class="text-3xl font-bold font-mono mt-1 text-success" id="resolved-count">-</p>
            </div>
            <div class="w-12 h-12 rounded-xl bg-success/20 flex items-center justify-center">
                <svg class="w-6 h-6 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
        </div>
    </div>
</div>

<!-- Incidents List -->
<div class="glass rounded-2xl overflow-hidden">
    <div class="overflow-x-auto">
        <table class="table">
            <thead>
                <tr class="text-base-content/60 border-b border-base-content/10">
                    <th class="bg-transparent">Incident</th>
                    <th class="bg-transparent">Severity</th>
                    <th class="bg-transparent">Status</th>
                    <th class="bg-transparent">Started</th>
                    <th class="bg-transparent">Duration</th>
                    <th class="bg-transparent">RCA</th>
                    <th class="bg-transparent"></th>
                </tr>
            </thead>
            <tbody id="incidents-table">
                <tr>
                    <td colspan="7" class="text-center py-12">
                        <span class="loading loading-spinner loading-lg text-primary"></span>
                        <p class="text-base-content/60 mt-4">Loading incidents...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div class="flex items-center justify-between p-4 border-t border-base-content/10">
        <div class="text-sm text-base-content/60" id="pagination-info">
            Showing 0 of 0 incidents
        </div>
        <div class="join">
            <button class="join-item btn btn-sm" id="prev-btn" onclick="prevPage()" disabled>«</button>
            <button class="join-item btn btn-sm" id="page-indicator">Page 1</button>
            <button class="join-item btn btn-sm" id="next-btn" onclick="nextPage()" disabled>»</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentPage = 1;
const pageSize = 20;
let totalPages = 1;

async function fetchIncidents() {
    const statusFilter = document.getElementById('status-filter').value;
    const severityFilter = document.getElementById('severity-filter').value;
    
    let url = `/api/incidents?page=${currentPage}&size=${pageSize}`;
    if (statusFilter) url += `&status=${statusFilter}`;
    if (severityFilter) url += `&severity=${severityFilter}`;
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        
        const tbody = document.getElementById('incidents-table');
        
        // Update stats
        document.getElementById('total-count').textContent = data.total;
        
        // Calculate status counts from current page (simplified)
        const openCount = data.items.filter(i => i.status === 'OPEN').length;
        const investigatingCount = data.items.filter(i => i.status === 'INVESTIGATING').length;
        const resolvedCount = data.items.filter(i => i.status === 'RESOLVED').length;
        
        document.getElementById('open-count').textContent = openCount;
        document.getElementById('investigating-count').textContent = investigatingCount;
        document.getElementById('resolved-count').textContent = resolvedCount;
        
        // Update pagination
        totalPages = Math.ceil(data.total / pageSize) || 1;
        document.getElementById('pagination-info').textContent = 
            `Showing ${data.items.length} of ${data.total} incidents`;
        document.getElementById('page-indicator').textContent = `Page ${currentPage}`;
        document.getElementById('prev-btn').disabled = currentPage <= 1;
        document.getElementById('next-btn').disabled = currentPage >= totalPages;
        
        if (data.items.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-16">
                        <div class="flex flex-col items-center gap-4">
                            <div class="w-20 h-20 rounded-full bg-success/20 flex items-center justify-center">
                                <svg class="w-10 h-10 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="font-semibold text-lg">No Incidents Found</p>
                                <p class="text-base-content/60">
                                    ${statusFilter || severityFilter ? 'No incidents match your filters.' : 'All systems are running smoothly!'}
                                </p>
                            </div>
                            <a href="/demo" class="btn btn-primary btn-sm gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                                </svg>
                                Run a Demo
                            </a>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = data.items.map((incident, idx) => {
            const duration = incident.end_time 
                ? (new Date(incident.end_time) - new Date(incident.start_time)) / 1000
                : null;
            
            return `
                <tr class="hover:bg-base-200/30 transition-colors border-b border-base-content/5" 
                    style="animation: fadeIn 0.3s ease ${idx * 0.03}s both">
                    <td>
                        <a href="/incidents/${incident.id}" class="group">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl ${
                                    incident.status === 'OPEN' ? 'bg-error/20' :
                                    incident.status === 'INVESTIGATING' ? 'bg-warning/20' : 'bg-success/20'
                                } flex items-center justify-center">
                                    ${getStatusIcon(incident.status)}
                                </div>
                                <div>
                                    <p class="font-medium group-hover:text-primary transition-colors">${incident.title}</p>
                                    <p class="text-xs text-base-content/50 font-mono">${incident.id.substring(0, 12)}...</p>
                                </div>
                            </div>
                        </a>
                    </td>
                    <td>
                        <div class="badge ${getSeverityClass(incident.severity)} font-mono">
                            ${incident.severity}
                        </div>
                    </td>
                    <td>
                        <div class="badge ${getStatusClass(incident.status)} badge-outline">
                            ${incident.status}
                        </div>
                    </td>
                    <td class="font-mono text-sm text-base-content/70">
                        ${formatDate(incident.start_time)}
                    </td>
                    <td class="font-mono text-sm">
                        ${duration !== null 
                            ? `<span class="text-success">${formatDuration(duration)}</span>`
                            : '<span class="badge badge-warning badge-sm animate-pulse">Ongoing</span>'
                        }
                    </td>
                    <td>
                        ${incident.rca_markdown 
                            ? '<span class="badge badge-success badge-outline badge-sm gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Ready</span>'
                            : '<span class="badge badge-ghost badge-sm">Pending</span>'
                        }
                    </td>
                    <td>
                        <a href="/incidents/${incident.id}" class="btn btn-ghost btn-sm btn-circle">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </a>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Failed to fetch incidents:', error);
        document.getElementById('incidents-table').innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-8 text-error">
                    Failed to load incidents. <button onclick="fetchIncidents()" class="btn btn-ghost btn-sm">Retry</button>
                </td>
            </tr>
        `;
    }
}

function applyFilters() {
    currentPage = 1;
    fetchIncidents();
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        fetchIncidents();
    }
}

function nextPage() {
    if (currentPage < totalPages) {
        currentPage++;
        fetchIncidents();
    }
}

// CSS for animations
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
`;
document.head.appendChild(style);

// Initial load
fetchIncidents();

// Auto-refresh every 30 seconds
setInterval(fetchIncidents, 30000);
</script>
{% endblock %}
